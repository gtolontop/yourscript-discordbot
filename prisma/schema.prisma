generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id // Discord user ID
  xp        Int      @default(0)
  level     Int      @default(0)
  balance   Int      @default(100) // Starting balance
  lastDaily DateTime?
  visibleXp Boolean  @default(true) // Show on leaderboard
  warns     Warn[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Warn {
  id         Int      @id @default(autoincrement())
  reason     String
  odbyUserId String   // User who received the warn
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  odByModId  String   // Moderator who gave the warn
  guildId    String
  timestamp  DateTime @default(now())
  createdAt  DateTime @default(now())
}

model Guild {
  id               String  @id // Discord guild ID

  // Log channels
  logCategoryId        String? // Category ID for all log channels
  allLogsChannel       String? // All logs combined
  modLogsChannel       String? // Ban, kick, mute, warn, unmute, clear
  msgLogsChannel       String? // Message delete, edit, bulk delete, pin
  voiceLogsChannel     String? // Voice join, leave, move, mute, deafen, stream, camera
  memberLogsChannel    String? // Role changes, nickname, avatar, timeout
  serverLogsChannel    String? // Channel/role CRUD, guild settings
  dashboardLogsChannel String? // Dashboard activity logs
  joinLeaveLogsChannel String? // Member join/leave
  banLogsChannel       String? // Ban/unban events
  inviteLogsChannel    String? // Invite create/delete
  threadLogsChannel    String? // Thread create/delete/update
  emojiLogsChannel     String? // Emoji create/delete/update
  boostLogsChannel     String? // Server boost/unboost
  cmdLogsChannel       String? // Command execution logs

  // Ticket system
  ticketCategoryId      String? // Category for ticket channels
  ticketTranscriptChannel String? // Channel for transcripts
  ticketReviewChannel   String? // Channel for staff review (accept/refuse)
  ticketPublicReviewChannel String? // Public channel for accepted reviews
  ticketCounter         Int     @default(0) // Ticket number counter
  ticketSupportRole     String? // Role that can see tickets

  // Ticket modal config
  ticketModalLabel      String  @default("Sujet (optionnel)")
  ticketModalPlaceholder String @default("Décris brièvement ton problème...")
  ticketModalRequired   Boolean @default(false)

  // Ghost ping on join
  ghostPingChannels   String? // JSON array of channel IDs for ghost ping

  // Other channels
  levelUpChannel      String? // Channel pour les annonces de level up
  welcomeChannel      String?
  welcomeMessage      String?
  leaveChannel        String?
  leaveMessage        String?
  levelUpMessage      String? @default("GG {user}, tu es maintenant niveau **{level}** !")
  suggestionChannel   String? // Channel for suggestions
  suggestionApprovedChannel String? // Channel for approved suggestions
  starboardChannel    String? // Starboard channel
  starboardThreshold  Int     @default(3) // Minimum stars to appear
  xpCooldown       Int     @default(60) // Seconds between XP gains
  xpMin            Int     @default(15)
  xpMax            Int     @default(25)

  // AI settings
  aiEnabled       Boolean @default(false)
  aiAutoRespond   Boolean @default(true)
  aiResponseDelay Int     @default(3)
  aiUrgentChannel String?
  aiTodoChannel   String?
  aiDmLogChannel  String? // Channel for DM log threads

  // Tebex Integration
  tebexSecret     String? // Webhook secret from Tebex
  tebexRoleReward String? // Role ID given on purchase
  tebexChannel    String? // Channel for purchase logs/welcomes
  tebexWelcomeMsg String? // Custom Tebex welcome message

  // Anti-Scam & Moderation
  antiScamEnabled Boolean @default(false)
  antiRaidEnabled Boolean @default(false) // Locks server
  altFlaggingEnabled Boolean @default(false)

  // VoiceMaster (Temporary Voice Channels)
  voiceMasterCategoryId String?
  voiceMasterChannelId  String?


  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  voiceSession     VoiceSession?
  tickets          Ticket[]
}

model VoiceSession {
  id        String   @id // Guild ID
  channelId String   // Voice channel ID
  is247     Boolean  @default(false) // Mode 24/7 actif
  guild     Guild    @relation(fields: [id], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model TempVoice {
  id        String   @id // Voice channel ID
  guildId   String
  ownerId   String   // User who created it
  createdAt DateTime @default(now())
  
  // Can't have multiple TempVoices per user per guild
  @@unique([guildId, ownerId])
}

model Ticket {
  id          Int      @id @default(autoincrement())
  number      Int      // Ticket number (per guild)
  channelId   String   @unique // Discord channel ID
  userId      String   // User who created the ticket
  guildId     String
  guild       Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  category    String?  // Ticket category (Support, Achat, Other)
  subject     String?  // Optional subject/reason
  status      String   @default("open") // open, closed, review
  priority    String   @default("normal") // low, normal, high, urgent
  claimedBy   String?  // Staff who claimed the ticket
  closedBy    String?  // User who closed the ticket
  closedAt    DateTime?
  review      String?  // Review text from user
  reviewRating Int?    // 1-5 stars
  lastActivity DateTime @default(now()) // For auto-close
  createdAt   DateTime @default(now())
}

model TicketCategory {
  id                Int      @id @default(autoincrement())
  guildId           String
  name              String   // Category name (Support, Achat, etc.)
  emoji             String?  // Emoji for the category
  description       String?  // Description shown in select menu
  categoryChannelId String?  // Discord category ID where tickets open (overrides default)
  modalTitle        String?  // Custom modal title (default: "Ticket - {name}")
  modalFields       String   @default("[]") // JSON array of modal fields config
  position          Int      @default(0)    // Order position in dropdown
  createdAt         DateTime @default(now())

  @@unique([guildId, name])
}

model TicketBlacklist {
  id        Int      @id @default(autoincrement())
  guildId   String
  userId    String
  reason    String?
  addedBy   String   // Staff who added the blacklist
  createdAt DateTime @default(now())

  @@unique([guildId, userId])
}

model Suggestion {
  id          Int      @id @default(autoincrement())
  guildId     String
  userId      String
  messageId   String   @unique // Message in suggestions channel
  content     String
  status      String   @default("pending") // pending, approved, rejected
  staffId     String?  // Staff who handled it
  staffReason String?  // Reason for approval/rejection
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  createdAt   DateTime @default(now())
}

model Giveaway {
  id            Int      @id @default(autoincrement())
  guildId       String
  channelId     String
  messageId     String   @unique
  hostId        String   // User who created the giveaway
  prize         String
  winners       Int      @default(1)
  requiredRole  String?  // Role required to enter
  requiredLevel Int?     // Level required to enter
  requiredVoice String?  // Voice channel ID required to enter
  endsAt        DateTime
  ended         Boolean  @default(false)
  winnerIds     String   @default("[]") // JSON array of winner IDs
  participants  String   @default("[]") // JSON array of participant IDs
  createdAt     DateTime @default(now())
}

model ReactionRole {
  id        Int      @id @default(autoincrement())
  guildId   String
  channelId String
  messageId String
  roleId    String
  emoji     String   // Emoji or custom emoji ID
  label     String?  // Button label if using buttons
  style     String   @default("primary") // Button style
  createdAt DateTime @default(now())

  @@unique([messageId, roleId])
}

model AutoRole {
  id        Int      @id @default(autoincrement())
  guildId   String
  roleId    String
  type      String   @default("join") // join, bot
  delay     Int      @default(0) // Delay in seconds
  createdAt DateTime @default(now())

  @@unique([guildId, roleId])
}

model LevelRole {
  id        Int      @id @default(autoincrement())
  guildId   String
  level     Int
  roleId    String
  createdAt DateTime @default(now())

  @@unique([guildId, level])
  @@unique([guildId, roleId])
}


model RoleAllJob {
  id            Int      @id @default(autoincrement())
  guildId       String
  roleId        String   // Role to add/remove
  action        String   // "add" or "remove"
  includeBots   Boolean  @default(false)
  memberIds     String   // JSON array of member IDs to process
  processedIds  String   @default("[]") // JSON array of processed member IDs
  success       Int      @default(0)
  failed        Int      @default(0)
  status        String   @default("running") // running, completed, paused
  channelId     String?  // Channel to send updates
  messageId     String?  // Message to edit for progress
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Transcript {
  id           String   @id @default(uuid()) // UUID for URL
  ticketId     Int
  ticketNumber Int
  guildId      String
  guildName    String
  userId       String
  userName     String
  closedBy     String
  closedByName String
  subject      String?
  category     String?
  messageCount Int
  html         String   // HTML content
  createdAt    DateTime @default(now())
}

model Session {
  id        String   @id
  sid       String   @unique
  data      String
  expiresAt DateTime
}

model EmbedTemplate {
  id          Int      @id @default(autoincrement())
  guildId     String
  name        String
  embed       String   // JSON stringified embed data
  createdAt   DateTime @default(now())

  @@unique([guildId, name])
}

model DashboardLog {
  id          Int      @id @default(autoincrement())
  guildId     String
  userId      String   // User who performed the action
  action      String   // Config Updated, Embed Sent, etc.
  details     String   // Details of the action
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([guildId, timestamp])
}

model BotConfig {
  id            String   @id @default("bot") // Singleton
  statusType    String?  // playing, watching, listening, competing, streaming
  statusText    String?  // Status text
  statusUrl     String?  // Stream URL (for streaming type)
  updatedAt     DateTime @updatedAt
}

model Service {
  id          Int      @id @default(autoincrement())
  guildId     String
  name        String   // Service name (e.g., "Site Web", "Bot Discord")
  emoji       String?  // Emoji for the service
  description String   // Service description
  price       String?  // Price (e.g., "À partir de 50€", "Sur devis")
  features    String   @default("[]") // JSON array of features
  category    String   @default("other") // fivem, web, design, other
  position    Int      @default(0) // Order position
  createdAt   DateTime @default(now())

  @@unique([guildId, name])
}

model ServicePanel {
  id          Int      @id @default(autoincrement())
  guildId     String   @unique
  channelId   String?  // Channel where the panel is
  messageId   String?  // Message ID of the panel
  title       String   @default("Nos Services")
  description String?  // Optional description
  color       Int      @default(5793266) // Default blurple
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Rule {
  id          Int      @id @default(autoincrement())
  guildId     String
  number      Int      // Rule number
  title       String   // Rule title
  description String   // Rule description
  createdAt   DateTime @default(now())

  @@unique([guildId, number])
}

model RulesPanel {
  id          Int      @id @default(autoincrement())
  guildId     String   @unique
  channelId   String?  // Channel where the panel is
  messageId   String?  // Message ID of the panel
  title       String   @default("Règlement du Serveur")
  footer      String?  // Footer text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TeamMember {
  id          Int      @id @default(autoincrement())
  guildId     String
  userId      String
  name        String
  role        String   // owner, developer, designer, support, manager
  specialties String   @default("[]") // JSON array: ["fivem","discord","web"]
  available   Boolean  @default(true)
  createdAt   DateTime @default(now())
  @@unique([guildId, userId])
}

model Todo {
  id           Int       @id @default(autoincrement())
  guildId      String
  title        String
  description  String?
  priority     String    @default("normal") // low, normal, high, urgent
  status       String    @default("open")   // open, in_progress, done, cancelled
  assigneeId   String?
  fromTicketId Int?
  dueDate      DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  @@index([guildId, status])
  @@index([assigneeId, status])
}

model TicketSummary {
  id           Int      @id @default(autoincrement())
  ticketId     Int
  channelId    String
  guildId      String
  summary      String   // Current cumulative summary
  keyPoints    String   @default("[]") // JSON array of key points
  sentiment    String   @default("neutral") // overall sentiment temperature
  trend        String   @default("stable") // improving, stable, declining
  suggestions  String   @default("[]") // JSON array of things to say/do next
  messageCount Int      @default(0) // Messages summarized so far
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  @@unique([ticketId])
  @@index([channelId])
}

model AIMemory {
  id             Int       @id @default(autoincrement())
  guildId        String
  userId         String
  type           String    // preference, interaction, note, issue
  content        String
  embedding      String?   // JSON float32 array
  embeddingModel String?   // Model that generated the embedding
  importance     Int       @default(5) // 1-10
  createdAt      DateTime  @default(now())
  expiresAt      DateTime?
  @@index([guildId, userId])
}

model AIKnowledge {
  id        Int      @id @default(autoincrement())
  guildId   String
  category  String   // business, glossary, instructions, faq, product
  key       String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([guildId, key])
  @@index([guildId, category])
}

model AIRequestLog {
  id           Int      @id @default(autoincrement())
  model        String
  tokensIn     Int
  tokensOut    Int
  cachedTokens Int      @default(0)
  cost         Float
  latencyMs    Int
  taskType     String
  ticketId     String?
  guildId      String?
  date         String   // YYYY-MM-DD
  createdAt    DateTime @default(now())

  @@index([date])
  @@index([ticketId])
  @@index([guildId, date])
}

model AIBudgetDay {
  id               Int      @id @default(autoincrement())
  date             String   @unique
  totalSpend       Float    @default(0)
  totalRequests    Int      @default(0)
  totalTokensIn    Int      @default(0)
  totalTokensOut   Int      @default(0)
  totalCached      Int      @default(0)
  avgCostPerTicket Float    @default(0)
  byModel          String   @default("{}")
  byTaskType       String   @default("{}")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model AITicketCost {
  id         Int       @id @default(autoincrement())
  ticketId   Int
  channelId  String
  guildId    String
  totalCost  Float     @default(0)
  totalCalls Int       @default(0)
  modelsUsed String    @default("[]")
  startedAt  DateTime  @default(now())
  closedAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([ticketId])
  @@index([guildId])
}

model AIReminder {
  id           Int       @id @default(autoincrement())
  guildId      String?
  userId       String
  targetUserId String?
  content      String
  channelId    String?   // null = DM
  triggerAt    DateTime
  fired        Boolean   @default(false)
  sourceType   String    @default("ticket") // ticket, dm, manual
  sourceId     String?
  createdAt    DateTime  @default(now())
  @@index([triggerAt, fired])
  @@index([userId])
}

model TebexPayment {
  id            String   @id // Tebex transaction ID (e.g., tbx-12345)
  guildId       String
  discordUserId String?
  discordUserTag String?
  amount        Float
  currency      String
  packages      String   @default("[]") // JSON array of package IDs/Names
  status        String   // Complete, Refunded, Chargeback
  email         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([discordUserId])
  @@index([guildId])
}
